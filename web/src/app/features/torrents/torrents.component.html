<div class="page-container">
  <div class="page-header">
    <h2>Torrents</h2>
    <div class="header-actions">
      <button class="btn btn-secondary"
              [class.active]="compactMode()"
              (click)="toggleCompactMode()"
              [title]="compactMode() ? 'Expand table' : 'Compact table'">
        <i class="fa-solid" [class.fa-table-columns]="compactMode()" [class.fa-table]="!compactMode()"></i>
      </button>
      <button class="btn btn-primary" (click)="loadTorrents()">
        <i class="fa-solid fa-arrows-rotate"></i>
        <span>Refresh</span>
      </button>
    </div>
  </div>

  @if (loading()) {
    <app-loading-container size="lg" />
  } @else {
    <div class="filter-bar">
      <div class="filter-row">
        <div class="search-field">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="text" class="form-input"
                 placeholder="Search by name..."
                 [value]="searchText()"
                 (input)="onSearchChange($event)" />
        </div>
        <div class="filter-dropdowns">
          <div class="custom-dropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-trigger" [class.open]="openDropdown() === 'state'" (click)="toggleDropdown('state')">
              <span>{{ stateFilterLabel() }}</span>
              <i class="fa-solid fa-chevron-down dropdown-chevron"></i>
            </button>
            @if (openDropdown() === 'state') {
              <div class="dropdown-panel">
                <div class="dropdown-option" [class.selected]="stateFilter() === ''" (click)="onStateFilterChange('')">All States</div>
                @for (state of availableStates(); track state) {
                  <div class="dropdown-option" [class.selected]="stateFilter() === state" (click)="onStateFilterChange(state)">
                    {{ getStateLabel(state) }} ({{ state }})
                  </div>
                }
              </div>
            }
          </div>

          <div class="custom-dropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-trigger" [class.open]="openDropdown() === 'category'" (click)="toggleDropdown('category')">
              <span>{{ categoryFilterLabel() }}</span>
              <i class="fa-solid fa-chevron-down dropdown-chevron"></i>
            </button>
            @if (openDropdown() === 'category') {
              <div class="dropdown-panel">
                <div class="dropdown-option" [class.selected]="categoryFilter() === ''" (click)="onCategoryFilterChange('')">All Categories</div>
                @for (cat of availableCategories(); track cat) {
                  <div class="dropdown-option" [class.selected]="categoryFilter() === cat" (click)="onCategoryFilterChange(cat)">
                    {{ cat }}
                  </div>
                }
              </div>
            }
          </div>

          <div class="custom-dropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-trigger" [class.open]="openDropdown() === 'type'" (click)="toggleDropdown('type')">
              <span>{{ typeFilterLabel() }}</span>
              <i class="fa-solid fa-chevron-down dropdown-chevron"></i>
            </button>
            @if (openDropdown() === 'type') {
              <div class="dropdown-panel">
                <div class="dropdown-option" [class.selected]="typeFilter() === 'all'" (click)="onTypeFilterChange('all')">All Types</div>
                <div class="dropdown-option" [class.selected]="typeFilter() === 'private'" (click)="onTypeFilterChange('private')">Private</div>
                <div class="dropdown-option" [class.selected]="typeFilter() === 'public'" (click)="onTypeFilterChange('public')">Public</div>
              </div>
            }
          </div>

          <div class="custom-dropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-trigger" [class.open]="openDropdown() === 'blacklist'" (click)="toggleDropdown('blacklist')">
              <span>{{ blacklistFilterLabel() }}</span>
              <i class="fa-solid fa-chevron-down dropdown-chevron"></i>
            </button>
            @if (openDropdown() === 'blacklist') {
              <div class="dropdown-panel">
                <div class="dropdown-option" [class.selected]="blacklistFilter() === 'all'" (click)="onBlacklistFilterChange('all')">All Blacklist</div>
                <div class="dropdown-option" [class.selected]="blacklistFilter() === 'yes'" (click)="onBlacklistFilterChange('yes')">Blacklisted</div>
                <div class="dropdown-option" [class.selected]="blacklistFilter() === 'no'" (click)="onBlacklistFilterChange('no')">Not Blacklisted</div>
              </div>
            }
          </div>

          <div class="custom-dropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-trigger" [class.open]="openDropdown() === 'tracker'" (click)="toggleDropdown('tracker')">
              <span>{{ trackerFilterLabel() }}</span>
              <i class="fa-solid fa-chevron-down dropdown-chevron"></i>
            </button>
            @if (openDropdown() === 'tracker') {
              <div class="dropdown-panel">
                <div class="dropdown-option" [class.selected]="trackerFilter() === ''" (click)="onTrackerFilterChange('')">All Trackers</div>
                @for (tracker of availableTrackers(); track tracker) {
                  <div class="dropdown-option" [class.selected]="trackerFilter() === tracker" (click)="onTrackerFilterChange(tracker)">
                    {{ tracker }}
                  </div>
                }
              </div>
            }
          </div>

          <div class="custom-dropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-trigger" [class.open]="openDropdown() === 'unregistered'" (click)="toggleDropdown('unregistered')">
              <span>{{ unregisteredFilterLabel() }}</span>
              <i class="fa-solid fa-chevron-down dropdown-chevron"></i>
            </button>
            @if (openDropdown() === 'unregistered') {
              <div class="dropdown-panel">
                <div class="dropdown-option" [class.selected]="unregisteredFilter() === 'all'" (click)="onUnregisteredFilterChange('all')">All Unregistered</div>
                <div class="dropdown-option" [class.selected]="unregisteredFilter() === 'yes'" (click)="onUnregisteredFilterChange('yes')">Unregistered</div>
                <div class="dropdown-option" [class.selected]="unregisteredFilter() === 'no'" (click)="onUnregisteredFilterChange('no')">Registered</div>
              </div>
            }
          </div>
        </div>
      </div>

      @if (hasActiveFilters()) {
        <div class="filter-chips-row">
          <div class="filter-chips">
            @for (filter of activeFilters(); track filter.type) {
              <span class="filter-chip">
                {{ filter.label }}
                <button class="chip-dismiss" (click)="removeFilter(filter)">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </span>
            }
          </div>
          <button class="btn btn-ghost btn-sm" (click)="clearAllFilters()">Clear All</button>
        </div>
      }
    </div>

    <div class="table-container" [class.compact-mode]="compactMode()">
      <table class="data-table">
        <thead>
          <tr>
            <th class="col-name sortable" (click)="sort('name')">
              Name
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'name' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'name' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'name'"></i>
            </th>
            <th class="col-state sortable" (click)="sort('state')">
              State
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'state' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'state' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'state'"></i>
            </th>
            <th class="col-ratio sortable" (click)="sort('ratio')">
              Ratio
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'ratio' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'ratio' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'ratio'"></i>
            </th>
            <th class="col-seed-time sortable" (click)="sort('seeding_time')">
              Seeding Time
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'seeding_time' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'seeding_time' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'seeding_time'"></i>
            </th>
            <th class="col-type sortable" (click)="sort('is_private')">
              Type
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'is_private' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'is_private' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'is_private'"></i>
            </th>
            <th class="col-size sortable" (click)="sort('size')">
              Size
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'size' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'size' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'size'"></i>
            </th>
            <th class="col-progress sortable" (click)="sort('progress')">
              Progress
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'progress' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'progress' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'progress'"></i>
            </th>
            <th class="col-blacklist sortable" (click)="sort('is_blacklisted')">
              Blacklisted
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'is_blacklisted' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'is_blacklisted' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'is_blacklisted'"></i>
            </th>
            <th class="col-actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (torrent of paginatedTorrents(); track torrent.hash) {
            <tr [class.blacklisted-row]="torrent.is_blacklisted">
              <td class="col-name name-cell" [title]="torrent.name">{{ torrent.name }}</td>
              <td class="col-state">
                <span class="state-badge" [ngClass]="getStateColor(torrent.state, torrent.progress)">
                  {{ getStateLabel(torrent.state, torrent.progress) }}
                </span>
                @if (torrent.is_unregistered) {
                  <span class="state-badge unregistered-badge">Unreg</span>
                }
              </td>
              <td class="col-ratio">{{ torrent.ratio | number:'1.2-2' }}</td>
              <td class="col-seed-time">{{ formatSeedingTime(torrent.seeding_time) }}</td>
              <td class="col-type">
                @if (torrent.is_private) {
                  <span class="type-badge private">Private</span>
                } @else {
                  <span class="type-badge public">Public</span>
                }
              </td>
              <td class="col-size">{{ formatSize(torrent.size) }}</td>
              <td class="col-progress">{{ formatProgress(torrent.progress) }}</td>
              <td class="col-blacklist">
                @if (torrent.is_blacklisted) {
                  <i class="fa-solid fa-shield blacklisted-icon"></i>
                }
              </td>
              <td class="col-actions">
                <button class="btn btn-icon" title="Actions" (click)="openActionMenu($event, torrent.hash)">
                  <i class="fa-solid fa-ellipsis-vertical"></i>
                </button>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="9" class="no-data-cell">No torrents found</td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <div class="pagination-bar">
      <span class="pagination-info">{{ paginationInfo() }}</span>
      @if (totalPages() > 1) {
        <div class="pagination-controls">
          <button class="btn btn-secondary btn-sm" [disabled]="currentPage() === 0" (click)="prevPage()">Previous</button>
          <span class="page-info">Page {{ currentPage() + 1 }} of {{ totalPages() }}</span>
          <button class="btn btn-secondary btn-sm" [disabled]="currentPage() >= totalPages() - 1" (click)="nextPage()">Next</button>
        </div>
      }
    </div>
  }
</div>

@if (actionMenuHash(); as hash) {
  <div class="action-menu-backdrop" (click)="actionMenuHash.set('')"></div>
  <div class="action-menu" [style.top.px]="actionMenuPos().top" [style.left.px]="actionMenuPos().left">
    @for (torrent of getMenuTorrent(hash); track torrent.hash) {
      <button class="action-menu-item" (click)="toggleBlacklist(torrent)">
        @if (torrent.is_blacklisted) {
          <i class="fa-solid fa-shield-halved"></i>
          <span>Remove from Blacklist</span>
        } @else {
          <i class="fa-solid fa-shield"></i>
          <span>Add to Blacklist</span>
        }
      </button>
      <button class="action-menu-item danger" (click)="deleteTorrent(torrent)">
        <i class="fa-solid fa-trash-can"></i>
        <span>Delete Torrent</span>
      </button>
    }
  </div>
}

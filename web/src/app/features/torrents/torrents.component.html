<div class="page-container">
  <div class="page-header">
    <h2>Torrents</h2>
    <button class="btn btn-primary" (click)="loadTorrents()">
      <i class="fa-solid fa-arrows-rotate"></i>
      <span>Refresh</span>
    </button>
  </div>

  @if (loading()) {
    <app-loading-container size="lg" />
  } @else {
    <div class="table-container">
      <div class="table-toolbar">
        <div class="search-field">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="text" class="form-input"
                 placeholder="Filter by name, state, category..."
                 [value]="filterText()"
                 (input)="onFilterChange($event)" />
        </div>
        <div class="actions-dropdown">
          <button class="btn btn-secondary btn-sm" (click)="toggleActionsMenu()">
            <i class="fa-solid fa-filter"></i>
            <span>Actions</span>
            <i class="fa-solid fa-chevron-down" style="font-size: 10px; margin-left: 2px;"></i>
          </button>
          @if (showActionsMenu()) {
            <div class="dropdown-menu">
              <button class="dropdown-item" (click)="clearFilter()">
                <i class="fa-solid fa-xmark"></i> Clear Filter
              </button>
              <div class="dropdown-divider"></div>
              @for (state of availableStates(); track state) {
                <button class="dropdown-item" (click)="filterByState(state)">
                  <span class="state-badge state-sm" [ngClass]="getStateColor(state)">{{ getStateLabel(state) }}</span>
                </button>
              }
            </div>
          }
        </div>
      </div>

      <table class="data-table">
        <thead>
          <tr>
            <th (click)="sort('name')" class="sortable">
              Name
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'name' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'name' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'name'"></i>
            </th>
            <th (click)="sort('state')" class="sortable">
              State
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'state' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'state' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'state'"></i>
            </th>
            <th (click)="sort('ratio')" class="sortable">
              Ratio
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'ratio' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'ratio' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'ratio'"></i>
            </th>
            <th (click)="sort('seeding_time')" class="sortable">
              Seeding Time
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'seeding_time' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'seeding_time' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'seeding_time'"></i>
            </th>
            <th (click)="sort('is_private')" class="sortable">
              Type
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'is_private' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'is_private' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'is_private'"></i>
            </th>
            <th (click)="sort('size')" class="sortable">
              Size
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'size' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'size' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'size'"></i>
            </th>
            <th (click)="sort('progress')" class="sortable">
              Progress
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'progress' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'progress' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'progress'"></i>
            </th>
            <th (click)="sort('is_blacklisted')" class="sortable">
              Blacklisted
              <i class="fa-solid"
                 [class.fa-sort-up]="sortField() === 'is_blacklisted' && sortDirection() === 'asc'"
                 [class.fa-sort-down]="sortField() === 'is_blacklisted' && sortDirection() === 'desc'"
                 [class.fa-sort]="sortField() !== 'is_blacklisted'"></i>
            </th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (torrent of paginatedTorrents(); track torrent.hash) {
            <tr [class.blacklisted-row]="torrent.is_blacklisted">
              <td class="name-cell" [title]="torrent.name">{{ torrent.name }}</td>
              <td>
                <span class="state-badge" [ngClass]="getStateColor(torrent.state, torrent.progress)">
                  {{ getStateLabel(torrent.state, torrent.progress) }}
                </span>
              </td>
              <td>{{ torrent.ratio | number:'1.2-2' }}</td>
              <td>{{ formatSeedingTime(torrent.seeding_time) }}</td>
              <td>
                @if (torrent.is_private) {
                  <span class="type-badge private">Private</span>
                } @else {
                  <span class="type-badge public">Public</span>
                }
              </td>
              <td>{{ formatSize(torrent.size) }}</td>
              <td>{{ formatProgress(torrent.progress) }}</td>
              <td>
                @if (torrent.is_blacklisted) {
                  <i class="fa-solid fa-shield blacklisted-icon"></i>
                }
              </td>
              <td>
                <button class="btn btn-icon"
                        [title]="torrent.is_blacklisted ? 'Remove from blacklist' : 'Add to blacklist'"
                        (click)="toggleBlacklist(torrent)">
                  <i [class]="torrent.is_blacklisted ? 'fa-solid fa-circle-minus' : 'fa-solid fa-circle-plus'"></i>
                </button>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="9" class="no-data-cell">No torrents found</td>
            </tr>
          }
        </tbody>
      </table>

      @if (totalPages() > 1) {
        <div class="pagination">
          <button [disabled]="currentPage() === 0" (click)="prevPage()">Previous</button>
          <span class="page-info">Page {{ currentPage() + 1 }} of {{ totalPages() }}</span>
          <button [disabled]="currentPage() >= totalPages() - 1" (click)="nextPage()">Next</button>
        </div>
      }
    </div>
  }
</div>

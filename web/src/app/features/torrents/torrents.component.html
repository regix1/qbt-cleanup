<div class="page-container">
  <div class="page-header">
    <h2>Torrents</h2>
    <div class="header-actions">
      @if (isColumnsCustomized()) {
        <button class="btn btn-secondary"
                (click)="resetColumns()"
                title="Reset column order & sizes">
          <i class="fa-solid fa-arrow-rotate-left"></i>
        </button>
      }
      <button class="btn btn-secondary"
              [class.active]="compactMode()"
              (click)="toggleCompactMode()"
              [title]="compactMode() ? 'Expand table' : 'Compact table'">
        <i class="fa-solid" [class.fa-table-columns]="compactMode()" [class.fa-table]="!compactMode()"></i>
      </button>
      <button class="btn btn-primary" (click)="loadTorrents()">
        <i class="fa-solid fa-arrows-rotate"></i>
        <span>Refresh</span>
      </button>
    </div>
  </div>

  @if (loading()) {
    <app-loading-container size="lg" />
  } @else {
    <div class="filter-bar">
      <div class="filter-row">
        <div class="search-field">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="text" class="form-input"
                 placeholder="Search by name..."
                 [value]="searchText()"
                 (input)="onSearchChange($event)" />
        </div>
        <div class="filter-dropdowns">
          <div class="custom-dropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-trigger" [class.open]="openDropdown() === 'state'" (click)="toggleDropdown('state')" aria-label="Filter by state">
              <span>{{ stateFilterLabel() }}</span>
              <i class="fa-solid fa-chevron-down dropdown-chevron"></i>
            </button>
            @if (openDropdown() === 'state') {
              <div class="dropdown-panel">
                <div class="dropdown-option" [class.selected]="stateFilter() === ''" (click)="onStateFilterChange('')">All States</div>
                @for (state of availableStates(); track state) {
                  <div class="dropdown-option" [class.selected]="stateFilter() === state" (click)="onStateFilterChange(state)">
                    {{ getStateLabel(state) }} ({{ state }})
                  </div>
                }
              </div>
            }
          </div>

          <div class="custom-dropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-trigger" [class.open]="openDropdown() === 'category'" (click)="toggleDropdown('category')" aria-label="Filter by category">
              <span>{{ categoryFilterLabel() }}</span>
              <i class="fa-solid fa-chevron-down dropdown-chevron"></i>
            </button>
            @if (openDropdown() === 'category') {
              <div class="dropdown-panel">
                <div class="dropdown-option" [class.selected]="categoryFilter() === ''" (click)="onCategoryFilterChange('')">All Categories</div>
                @for (cat of availableCategories(); track cat) {
                  <div class="dropdown-option" [class.selected]="categoryFilter() === cat" (click)="onCategoryFilterChange(cat)">
                    {{ cat }}
                  </div>
                }
              </div>
            }
          </div>

          <div class="custom-dropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-trigger" [class.open]="openDropdown() === 'type'" (click)="toggleDropdown('type')" aria-label="Filter by type">
              <span>{{ typeFilterLabel() }}</span>
              <i class="fa-solid fa-chevron-down dropdown-chevron"></i>
            </button>
            @if (openDropdown() === 'type') {
              <div class="dropdown-panel">
                <div class="dropdown-option" [class.selected]="typeFilter() === 'all'" (click)="onTypeFilterChange('all')">All Types</div>
                <div class="dropdown-option" [class.selected]="typeFilter() === 'private'" (click)="onTypeFilterChange('private')">Private</div>
                <div class="dropdown-option" [class.selected]="typeFilter() === 'public'" (click)="onTypeFilterChange('public')">Public</div>
              </div>
            }
          </div>

          <div class="custom-dropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-trigger" [class.open]="openDropdown() === 'blacklist'" (click)="toggleDropdown('blacklist')" aria-label="Filter by blacklist status">
              <span>{{ blacklistFilterLabel() }}</span>
              <i class="fa-solid fa-chevron-down dropdown-chevron"></i>
            </button>
            @if (openDropdown() === 'blacklist') {
              <div class="dropdown-panel">
                <div class="dropdown-option" [class.selected]="blacklistFilter() === 'all'" (click)="onBlacklistFilterChange('all')">All Blacklist</div>
                <div class="dropdown-option" [class.selected]="blacklistFilter() === 'yes'" (click)="onBlacklistFilterChange('yes')">Blacklisted</div>
                <div class="dropdown-option" [class.selected]="blacklistFilter() === 'no'" (click)="onBlacklistFilterChange('no')">Not Blacklisted</div>
              </div>
            }
          </div>

          <div class="custom-dropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-trigger" [class.open]="openDropdown() === 'tracker'" (click)="toggleDropdown('tracker')" aria-label="Filter by tracker">
              <span>{{ trackerFilterLabel() }}</span>
              <i class="fa-solid fa-chevron-down dropdown-chevron"></i>
            </button>
            @if (openDropdown() === 'tracker') {
              <div class="dropdown-panel">
                <div class="dropdown-option" [class.selected]="trackerFilter() === ''" (click)="onTrackerFilterChange('')">All Trackers</div>
                @for (tracker of availableTrackers(); track tracker) {
                  <div class="dropdown-option" [class.selected]="trackerFilter() === tracker" (click)="onTrackerFilterChange(tracker)">
                    {{ tracker }}
                  </div>
                }
              </div>
            }
          </div>

          <div class="custom-dropdown" (click)="$event.stopPropagation()">
            <button class="dropdown-trigger" [class.open]="openDropdown() === 'unregistered'" (click)="toggleDropdown('unregistered')" aria-label="Filter by registration status">
              <span>{{ unregisteredFilterLabel() }}</span>
              <i class="fa-solid fa-chevron-down dropdown-chevron"></i>
            </button>
            @if (openDropdown() === 'unregistered') {
              <div class="dropdown-panel">
                <div class="dropdown-option" [class.selected]="unregisteredFilter() === 'all'" (click)="onUnregisteredFilterChange('all')">All Tracker Status</div>
                <div class="dropdown-option" [class.selected]="unregisteredFilter() === 'yes'" (click)="onUnregisteredFilterChange('yes')">Unregistered Only</div>
                <div class="dropdown-option" [class.selected]="unregisteredFilter() === 'no'" (click)="onUnregisteredFilterChange('no')">Registered Only</div>
              </div>
            }
          </div>
        </div>
      </div>

      @if (hasActiveFilters()) {
        <div class="filter-chips-row">
          <div class="filter-chips">
            @for (filter of activeFilters(); track filter.type) {
              <span class="filter-chip">
                {{ filter.label }}
                <button class="chip-dismiss" (click)="removeFilter(filter)">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </span>
            }
          </div>
          <button class="btn btn-ghost btn-sm" (click)="clearAllFilters()">Clear All</button>
        </div>
      }
    </div>

    <div class="table-container"
         [class.compact-mode]="compactMode()"
         [class.is-resizing]="isResizing()">
      <table class="data-table" [class.fixed-layout]="hasCustomWidths()">
        <thead>
          <tr cdkDropList
              cdkDropListOrientation="horizontal"
              (cdkDropListDropped)="onColumnDrop($event)">
            @for (col of columnOrder(); track col.id) {
              <th [class]="col.cssClass"
                  [class.sortable]="!!col.sortField"
                  [style.width.px]="getColumnWidth(col)"
                  cdkDrag>
                <i class="fa-solid fa-grip-vertical drag-handle" cdkDragHandle></i>
                <span class="th-sort-trigger" (click)="onHeaderClick(col)">
                  {{ col.label }}
                  @if (col.sortField) {
                    <i class="fa-solid"
                       [class.fa-sort-up]="sortField() === col.sortField && sortDirection() === 'asc'"
                       [class.fa-sort-down]="sortField() === col.sortField && sortDirection() === 'desc'"
                       [class.fa-sort]="sortField() !== col.sortField"></i>
                  }
                </span>
                <div class="resize-handle" (mousedown)="onResizeStart($event, col)"></div>
                <ng-template cdkDragPreview>
                  <div class="column-drag-preview">
                    <i class="fa-solid fa-grip-vertical"></i>
                    {{ col.label }}
                  </div>
                </ng-template>
              </th>
            }
          </tr>
        </thead>
        <tbody>
          @for (torrent of paginatedTorrents(); track torrent.hash) {
            <tr [class.blacklisted-row]="torrent.is_blacklisted">
              @for (col of columnOrder(); track col.id) {
                @switch (col.id) {
                  @case ('name') {
                    <td class="col-name name-cell" [title]="torrent.name">{{ torrent.name }}</td>
                  }
                  @case ('state') {
                    <td class="col-state">
                      @if (recyclingHash() === torrent.hash || torrent.is_recycling) {
                        <span class="state-badge state-recycling">
                          <i class="fa-solid fa-spinner fa-spin"></i> Recycling
                        </span>
                      } @else {
                        <span class="state-badge" [ngClass]="getStateColor(torrent.state, torrent.progress)">
                          {{ getStateLabel(torrent.state, torrent.progress) }}
                        </span>
                        @if (torrent.is_unregistered) {
                          <span class="state-badge unregistered-badge">Unreg</span>
                        }
                      }
                    </td>
                  }
                  @case ('ratio') {
                    <td class="col-ratio">{{ torrent.ratio | number:'1.2-2' }}</td>
                  }
                  @case ('seedTime') {
                    <td class="col-seed-time">{{ formatSeedingTime(torrent.seeding_time) }}</td>
                  }
                  @case ('type') {
                    <td class="col-type">
                      @if (torrent.is_private) {
                        <span class="type-badge private">Private</span>
                      } @else {
                        <span class="type-badge public">Public</span>
                      }
                    </td>
                  }
                  @case ('size') {
                    <td class="col-size">{{ formatSize(torrent.size) }}</td>
                  }
                  @case ('progress') {
                    <td class="col-progress">{{ formatProgress(torrent.progress) }}</td>
                  }
                  @case ('blacklist') {
                    <td class="col-blacklist">
                      @if (torrent.is_blacklisted) {
                        <i class="fa-solid fa-shield blacklisted-icon"></i>
                      }
                    </td>
                  }
                  @case ('actions') {
                    <td class="col-actions">
                      @if (recyclingHash() === torrent.hash || torrent.is_recycling) {
                        <span class="recycling-indicator" title="Recycling...">
                          <i class="fa-solid fa-spinner fa-spin"></i>
                        </span>
                      } @else {
                        <button class="btn btn-icon" title="Actions" (click)="openActionMenu($event, torrent.hash)">
                          <i class="fa-solid fa-ellipsis-vertical"></i>
                        </button>
                      }
                    </td>
                  }
                }
              }
            </tr>
          } @empty {
            <tr>
              <td [attr.colspan]="columnOrder().length" class="no-data-cell">No torrents found</td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <div class="pagination-bar">
      <span class="pagination-info">{{ paginationInfo() }}</span>
      @if (totalPages() > 1) {
        <div class="pagination-controls">
          <button class="btn btn-secondary btn-sm" [disabled]="currentPage() === 0" (click)="prevPage()">Previous</button>
          <span class="page-info">Page {{ currentPage() + 1 }} of {{ totalPages() }}</span>
          <button class="btn btn-secondary btn-sm" [disabled]="currentPage() >= totalPages() - 1" (click)="nextPage()">Next</button>
        </div>
      }
    </div>
  }
</div>

@if (actionMenuHash(); as hash) {
  <div class="action-menu-backdrop" (click)="actionMenuHash.set('')"></div>
  <div class="action-menu" [style.top.px]="actionMenuPos().top" [style.left.px]="actionMenuPos().left">
    @for (torrent of getMenuTorrent(hash); track torrent.hash) {
      <button class="action-menu-item" (click)="toggleBlacklist(torrent)">
        @if (torrent.is_blacklisted) {
          <i class="fa-solid fa-shield-halved"></i>
          <span>Remove from Blacklist</span>
        } @else {
          <i class="fa-solid fa-shield"></i>
          <span>Add to Blacklist</span>
        }
      </button>
      <button class="action-menu-item" (click)="recycleTorrent(torrent)">
        <i class="fa-solid fa-recycle"></i>
        <span>Recycle Torrent</span>
      </button>
      <button class="action-menu-item danger" (click)="deleteTorrent(torrent)">
        <i class="fa-solid fa-trash-can"></i>
        <span>Delete Torrent</span>
      </button>
    }
  </div>
}

<div class="page-container">
  <div class="page-header">
    <h2>Configuration</h2>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="loadConfig()">
        <i class="fa-solid fa-arrows-rotate"></i>
        <span>Reload</span>
      </button>
      <button class="btn btn-primary"
              (click)="saveConfig()"
              [disabled]="!hasModifications() || saving()">
        @if (saving()) {
          <i class="fa-solid fa-spinner fa-spin"></i>
        } @else {
          <i class="fa-solid fa-floppy-disk"></i>
        }
        <span>Save Changes</span>
      </button>
    </div>
  </div>

  @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
    </div>
  } @else {
    <div class="accordion">
      @for (section of sections(); track section.key) {
        <div class="accordion-panel" [class.accordion-panel-open]="section.expanded">
          <div class="accordion-header" (click)="toggleSection(section)">
            <i [class]="section.icon + ' section-icon'"></i>
            <span class="section-name">{{ section.name }}</span>
            @if (sectionHasModifications(section)) {
              <span class="modified-badge">Modified</span>
            }
            <span class="spacer"></span>
            <span class="section-count">{{ section.fields.length }} settings</span>
            <i class="fa-solid fa-chevron-down accordion-chevron"></i>
          </div>
          @if (section.expanded) {
            <div class="accordion-content">
              <div class="fields-grid">
                @for (field of section.fields; track field.key) {
                  <div class="field-row" [class.field-modified]="field.modified">
                    <div class="field-info">
                      <span class="field-name">{{ formatFieldName(field.key) }}</span>
                      <span class="field-key">{{ field.key }}</span>
                      @if (getFieldDescription(section.key, field.key)) {
                        <span class="field-desc">{{ getFieldDescription(section.key, field.key) }}</span>
                      }
                    </div>

                    <div class="field-input">
                      @if (field.type === 'boolean') {
                        <div class="toggle-row">
                          <label class="toggle-switch">
                            <input type="checkbox"
                                   [(ngModel)]="field.editValue"
                                   (ngModelChange)="onFieldChange(section, field)">
                            <span class="toggle-slider"></span>
                          </label>
                          <span class="toggle-label">{{ field.editValue ? 'Enabled' : 'Disabled' }}</span>
                        </div>
                      } @else if (isScanDirsField(section.key, field.key)) {
                        <div class="scan-dirs-list">
                          @for (dir of getScanDirs(field); track $index) {
                            <div class="scan-dir-item">
                              <input class="form-input" type="text"
                                     [value]="dir"
                                     (input)="updateScanDir(section, field, $index, $any($event.target).value)"
                                     placeholder="/path/to/directory">
                              <button class="btn-icon remove-dir-btn" type="button"
                                      (click)="removeScanDir(section, field, $index)"
                                      title="Remove directory">
                                <i class="fa-solid fa-xmark"></i>
                              </button>
                            </div>
                          }
                          <button class="btn btn-secondary btn-sm add-dir-btn" type="button"
                                  (click)="addScanDir(section, field)">
                            <i class="fa-solid fa-plus"></i>
                            <span>Add Directory</span>
                          </button>
                        </div>
                      } @else if (field.type === 'number') {
                        <div class="number-input-wrapper">
                          <button class="number-btn" type="button"
                                  (click)="field.editValue = +field.editValue - 1; onFieldChange(section, field)">
                            <i class="fa-solid fa-minus"></i>
                          </button>
                          <input class="form-input number-input" type="number"
                                 [(ngModel)]="field.editValue"
                                 (ngModelChange)="onFieldChange(section, field)">
                          <button class="number-btn" type="button"
                                  (click)="field.editValue = +field.editValue + 1; onFieldChange(section, field)">
                            <i class="fa-solid fa-plus"></i>
                          </button>
                        </div>
                      } @else if (isPasswordField(section.key, field.key)) {
                        <div class="password-input-wrapper">
                          <input class="form-input"
                                 [type]="isPasswordVisible(field.key) ? 'text' : 'password'"
                                 [(ngModel)]="field.editValue"
                                 (ngModelChange)="onFieldChange(section, field)">
                          <button class="password-toggle" type="button" (click)="togglePasswordVisibility(field.key)">
                            <i [class]="isPasswordVisible(field.key) ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'"></i>
                          </button>
                        </div>
                      } @else {
                        <input class="form-input" type="text"
                               [(ngModel)]="field.editValue"
                               (ngModelChange)="onFieldChange(section, field)">
                      }
                    </div>

                    <div class="field-actions">
                      @if (field.modified) {
                        <button class="btn-icon" title="Reset to original value" (click)="resetField(field)">
                          <i class="fa-solid fa-rotate-left"></i>
                        </button>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
